<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Seguimiento Criptomonedas</title>
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 480px; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px;}
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center;}
  th { background: #333; color: white;}
  input[type="number"] { width: 80px; }
  #status { margin-bottom: 10px; color: green; font-weight: bold; }
</style>
</head>
<body>

<h1>Seguimiento Criptomonedas</h1>

<div id="status"></div>

<table>
  <thead>
    <tr>
      <th>Cripto</th>
      <th>Cantidad</th>
      <th>Precio compra (€)</th>
      <th>Precio actual (€)</th>
      <th>Ganancia/Pérdida (€)</th>
    </tr>
  </thead>
  <tbody id="tabla-criptos">
    <!-- Filas se generan con JS -->
  </tbody>
</table>

<button id="guardar">Guardar datos</button>

<script>
  // Config EmailJS
  const SERVICE_ID = 'service_ioorlfv';
  const TEMPLATE_ID = 'template_e5ibdr1';
  const PUBLIC_KEY = '9F2a-_3g1ZrA6kXwN';

  // Criptos a seguir
  const criptos = [
    {id:'bitcoin', nombre:'Bitcoin'},
    {id:'ethereum', nombre:'Ethereum'},
    {id:'dogecoin', nombre:'Dogecoin'},
    {id:'solana', nombre:'Solana'}
  ];

  // Umbral en euros para alertas
  const UMBRAL_EUROS = 5;

  // Para evitar spam, guardamos alertas enviadas (hash por cripto + tipo alerta)
  let alertasEnviadas = {};

  // Iniciar EmailJS
  emailjs.init(PUBLIC_KEY);

  // Cargar datos guardados o por defecto
  function cargarDatos() {
    const datos = JSON.parse(localStorage.getItem('misCriptos')) || {};
    return datos;
  }

  // Guardar datos en localStorage
  function guardarDatos(datos) {
    localStorage.setItem('misCriptos', JSON.stringify(datos));
    mostrarStatus('Datos guardados');
  }

  // Mostrar mensaje status
  function mostrarStatus(msg, error=false) {
    const status = document.getElementById('status');
    status.textContent = msg;
    status.style.color = error ? 'red' : 'green';
    setTimeout(() => { status.textContent = ''; }, 4000);
  }

  // Construir tabla con inputs para cantidad y precio compra
  function construirTabla(datos) {
    const tbody = document.getElementById('tabla-criptos');
    tbody.innerHTML = '';
    criptos.forEach(c => {
      const cantidad = datos[c.id]?.cantidad || '';
      const precioCompra = datos[c.id]?.precioCompra || '';
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${c.nombre}</td>
        <td><input type="number" step="any" min="0" data-id="${c.id}" data-tipo="cantidad" value="${cantidad}"></td>
        <td><input type="number" step="any" min="0" data-id="${c.id}" data-tipo="precioCompra" value="${precioCompra}"></td>
        <td id="actual-${c.id}">Cargando...</td>
        <td id="ganancia-${c.id}">-</td>
      `;
      tbody.appendChild(fila);
    });
  }

  // Obtener datos de la tabla (inputs)
  function obtenerDatosTabla() {
    const inputs = document.querySelectorAll('#tabla-criptos input');
    const datos = {};
    inputs.forEach(i => {
      const id = i.dataset.id;
      const tipo = i.dataset.tipo;
      if (!datos[id]) datos[id] = {};
      datos[id][tipo] = i.value ? parseFloat(i.value) : 0;
    });
    return datos;
  }

  // Enviar email alerta
  function enviarAlerta(monedaname, valorActual, valorCompra, ganancia) {
    const alertaIdSubida = monedaname + '_subida';
    const alertaIdBajada = monedaname + '_bajada';

    // Permitir alertas siempre (sin bloquear repetidos)

    const accion = ganancia > 0 ? 'Podrías vender' : 'Espera a que mejore';

    const templateParams = {
      moneda: monedaname,
      valor_actual: valorActual.toFixed(2),
      valor_compra: valorCompra.toFixed(2),
      ganancia: ganancia.toFixed(2),
      accion: accion
    };

    emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams)
      .then(() => {
        console.log('Alerta enviada para', monedaname);
      }, (error) => {
        console.error('Error al enviar alerta:', error);
      });
  }

  // Actualizar precios y calcular ganancias/pérdidas
  async function actualizarPrecios() {
    try {
      const resp = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${criptos.map(c => c.id).join(',')}&vs_currencies=eur`);
      const datosApi = await resp.json();
      const datosGuardados = obtenerDatosTabla();

      criptos.forEach(c => {
        const precioActual = datosApi[c.id]?.eur || 0;
        const precioCompra = datosGuardados[c.id]?.precioCompra || 0;
        const cantidad = datosGuardados[c.id]?.cantidad || 0;
        const ganancia = (precioActual - precioCompra) * cantidad;

        document.getElementById('actual-' + c.id).textContent = precioActual.toFixed(2) + ' €';
        document.getElementById('ganancia-' + c.id).textContent = ganancia.toFixed(2) + ' €';

        // Comprobar si ganancia o pérdida supera umbral
        if (cantidad > 0 && Math.abs(precioActual - precioCompra) > UMBRAL_EUROS) {
          enviarAlerta(c.nombre, precioActual, precioCompra, ganancia);
        }
      });
    } catch (error) {
      mostrarStatus('Error al cargar datos, intenta más tarde', true);
      console.error(error);
    }
  }

  // Al cargar la página
  window.onload = () => {
    const datos = cargarDatos();
    construirTabla(datos);
    actualizarPrecios();

    // Actualizar cada 60 segundos
    setInterval(actualizarPrecios, 60000);

    // Guardar datos al hacer click
    document.getElementById('guardar').onclick = () => {
      const datosAGuardar = obtenerDatosTabla();
      guardarDatos(datosAGuardar);
    };
  };
</script>

</body>
</html>
